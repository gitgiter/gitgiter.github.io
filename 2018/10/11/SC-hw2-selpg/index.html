<!DOCTYPE HTML>
<html>

<head><meta name="generator" content="Hexo 3.9.0">
	<link rel="bookmark" type="image/x-icon" href="/img/logo_miccall.png">
	<link rel="shortcut icon" href="/img/logo_miccall.png">
	
			    <title>
    gitgiter's blog
    </title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <link rel="stylesheet" href="/css/mic_main.css">
    <link rel="stylesheet" href="/css/dropdownMenu.css">
    <meta name="keywords" content="miccall">
    
    	<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
	 
    <noscript>
        <link rel="stylesheet" href="/css/noscript.css">
    </noscript>
    <style type="text/css">
        body:before {
          content: ' ';
          position: fixed;
          top: 0;
          background: url('/img/bg.jpg') center 0 no-repeat;
          right: 0;
          bottom: 0;
          left: 0;
          background-size: cover; 
        }
    </style>

			    
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script async type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


    <script src="/js/jquery.min.js"></script>
    <script src="/js/jquery.scrollex.min.js"></script>
    <script src="/js/jquery.scrolly.min.js"></script>
    <script src="/js/skel.min.js"></script>
    <script src="/js/util.js"></script>
    <script src="/js/main.js"></script>
	
</head>
    
		
<!-- Layouts -->



<!--  代码渲染  -->
<link rel="stylesheet" href="/css/prism_okaidia.css">
<link rel="stylesheet" href="/css/typo.css">
<!-- 文章页 -->
<body class="is-loading">
    <!-- Wrapper 外包 s-->
    <div id="wrapper" class="fade-in">
        <!-- Intro 头部显示 s -->
        <!-- Intro 头部显示 e -->
        <!-- Header 头部logo start -->
        <header id="header">
    <a href="/" class="logo">gitgiter</a>
</header>
        <!-- Nav 导航条 start -->
        <nav id="nav" class="special">
            <ul class="menu links">
			<!-- Homepage  主页  --> 
			<li>
	            <a href="/" rel="nofollow">主页</a>
	        </li>
			<!-- categories_name  分类   --> 
	        
	        <li class="active">
	            <a href="#s1">分类</a>
	                    <ul class="submenu">
	                        <li>
	                        
	                    </li></ul>
	        </li>
	        
	        <!-- archives  归档   --> 
	        
	        
		        <!-- Pages 自定义   -->
		        
		        <li>
		            <a href="/about/" title="简历">
		                简历
		            </a>
		        </li>
		        
		        <li>
		            <a href="/group/" title="团队">
		                团队
		            </a>
		        </li>
		        
		        <li>
		            <a href="/gallery/" title="图库">
		                图库
		            </a>
		        </li>
		        
		        <li>
		            <a href="/tag/" title="标签">
		                标签
		            </a>
		        </li>
		        


            </ul>
            <!-- icons 图标   -->
			<ul class="icons">
                    
                    <li>
                        <a title="github" href="https://github.com/gitgiter" target="_blank" rel="noopener">
                            <i class="icon fa fa-github"></i>
                        </a>
                    </li>
                    
                    <li>
                        <a title="500px" href="https://blog.csdn.net/Wonderful_sky" target="_blank" rel="noopener">
                            <i class="icon fa fa-500px"></i>
                        </a>
                    </li>
                    
			</ul>
</nav>

        <div id="main">
            <div class="post_page_title_img" style="height: 25rem;background-image: url(https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1539362762026&amp;di=a0fe5dc796b5f95dd11a6eed976188dd&amp;imgtype=0&amp;src=http%3A%2F%2Fdn-linuxcn.qbox.me%2Fdata%2Fattachment%2Falbum%2F201509%2F06%2F145049z4og8xyjhx4xy8go.jpg);background-position: center; background-repeat:no-repeat; background-size:cover;-moz-background-size:cover;overflow:hidden;">
                <a href="#" style="padding: 4rem 4rem 2rem 4rem ;"><h2>SC-hw2-CLI实用程序开发之selpg</h2></a>
            </div>
            <!-- Post -->
            <div class="typo" style="padding: 3rem;">
                <p>[Toc]</p>
<h1 id="CLI实用程序开发之selpg"><a href="#CLI实用程序开发之selpg" class="headerlink" title="CLI实用程序开发之selpg"></a>CLI实用程序开发之selpg</h1><hr>
<h2 id="1-准备知识"><a href="#1-准备知识" class="headerlink" title="1. 准备知识"></a>1. 准备知识</h2><h3 id="1-1-CLI实用程序"><a href="#1-1-CLI实用程序" class="headerlink" title="1.1 CLI实用程序"></a>1.1 CLI实用程序</h3><p>Command-Line Interface，简称CLI，是在图形用户界面得到普及之前使用得最为广泛的用户界面。随着互联网的发展，由于偏好图形界面的非专业人员参与，虽然让CLI使用比例有所下降，但CLI的简洁、灵活、高效的特性始终无法被替代，仍然一直是服务器开发（编程、调试、运维、管理等）的首选方式。因此，CLI实用程序是Linux下应用开发的基础，学好如何编写CLI实用工具便是Linux开发的基本功了。</p>
<h3 id="1-2-标准IO重定向"><a href="#1-2-标准IO重定向" class="headerlink" title="1.2 标准IO重定向"></a>1.2 标准IO重定向</h3><p>本篇博客涉及较多关于IO重定向的内容，主要有以下几个准则。</p>
<ul>
<li>输入<ul>
<li><code>command</code>：运行某命令，如需标准输入，默认为终端输入（ctrl+d结束输入）</li>
<li><code>command inputfile</code>：运行某命令，并指定inputfile为需要读取的文件</li>
<li><code>command &lt; inputfile</code>：运行某命令，将inputfile作为标准输入</li>
</ul>
</li>
<li>输出<ul>
<li><code>command</code>：运行某命令，如有标准输出，默认为终端输出</li>
<li><code>command &gt; outputfile</code>：运行某命令，并指定outputfile作为标准输出文件，如有输出结果就输出到outputfile中</li>
<li><code>command 2&gt; errorfile</code>：运行某命令，并指定errorfile作为错误输出文件，如有运行错误就输出到errorfile中</li>
</ul>
</li>
<li>以上准则可以适当组合使用</li>
</ul>
<h3 id="1-3-管道pipe"><a href="#1-3-管道pipe" class="headerlink" title="1.3 管道pipe"></a>1.3 管道pipe</h3><p>管道主要是一种进程间通信的机制，在Linux下用符号 | 创建管道，主要用于完成进程间数据传递。因为每个进程各自有不同的用户地址空间，于是A进程的数据独立于B进程互相无法访问，所以进程之间要交换数据必须通过内核，在内核中开辟一块缓冲区，进程A把数据从用户空间拷到内核缓冲，进程B再从内核缓冲区把数据读走，内核提供的这种机制称为进程间通信。</p>
<p>通过上面对管道的简单了解，可以发现管道在进程间也能起着输入输出重定向的作用。</p>
<ul>
<li><code>other_command | command</code>：将other_command的标准输出作为command的标准输入</li>
<li><code>command | other_command</code>：将command的标准输出作为other_command的标注输入</li>
</ul>
<h3 id="1-4-相关包"><a href="#1-4-相关包" class="headerlink" title="1.4 相关包"></a>1.4 相关包</h3><ul>
<li><strong>bufio</strong>：实现了带缓冲的IO，可以理解为实现了一些io包下的低水平接口，进而提供了较高水平的IO能力。</li>
<li><strong>flag</strong>：帮助实现命令行参数解析</li>
<li><strong>fmt</strong>：提供各种print方法</li>
<li><strong>io</strong>：顾名思义，提供一些有关IO的方法和可以被进一步实现的较低水平接口。</li>
<li><strong>math</strong>：数学包无需多说。</li>
<li><strong>os</strong>：提供了不依赖平台的操作系统函数及其接口。</li>
<li><strong>os/exec</strong>：提供了一些执行外部命令的方法。它包装了os.StartProcess函数以便更容易的修正输入和输出，使用管道连接I/O，以及作其它的一些调整。</li>
</ul>
<hr>
<h2 id="2-selpg简介"><a href="#2-selpg简介" class="headerlink" title="2. selpg简介"></a>2. selpg简介</h2><h3 id="2-1-源代码地址"><a href="#2-1-源代码地址" class="headerlink" title="2.1 源代码地址"></a>2.1 源代码地址</h3><p><a href="https://github.com/gitgiter/ServiceComputing/tree/master/selpg" target="_blank" rel="noopener">selpg</a></p>
<h3 id="2-2-程序说明"><a href="#2-2-程序说明" class="headerlink" title="2.2 程序说明"></a>2.2 程序说明</h3><p>selpg是一个命令行工具，允许用户指定该程序从标准输入或从作为命令行参数给出的文件名读取文本输入，并允许用户指定标准输出位置和输入输出的页范围。可以有选择性的查看或打印某个文档的部分内容，简单、高效、节约资源。</p>
<h3 id="2-3-文件说明"><a href="#2-3-文件说明" class="headerlink" title="2.3 文件说明"></a>2.3 文件说明</h3><table>
<thead>
<tr>
<th style="text-align:center">文件名</th>
<th style="text-align:center">用途</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">selpg.go</td>
<td style="text-align:center">核心功能文件，selpg功能的所有实现，包括错误处理</td>
</tr>
<tr>
<td style="text-align:center">selpg_input_generator.sh</td>
<td style="text-align:center">批处理文件，用于生成selpg_input.txt</td>
</tr>
<tr>
<td style="text-align:center">selpg_test.sh</td>
<td style="text-align:center">批处理文件，用于批量测试selpg</td>
</tr>
<tr>
<td style="text-align:center">selpg_input.txt</td>
<td style="text-align:center">可选输入文件，内容为1~10000的递增数列，用于对selpg进行一系列测试</td>
</tr>
<tr>
<td style="text-align:center">selpg_output.txt</td>
<td style="text-align:center">可选输出文件，用于测试selpg的输出重定向</td>
</tr>
<tr>
<td style="text-align:center">selpg_error.txt</td>
<td style="text-align:center">可选错误输出文件，用于测试selpg的错误输出重定向</td>
</tr>
</tbody>
</table>
<h3 id="2-4-参数格式"><a href="#2-4-参数格式" class="headerlink" title="2.4 参数格式"></a>2.4 参数格式</h3><table>
<thead>
<tr>
<th style="text-align:center">选项</th>
<th style="text-align:center">值类型</th>
<th style="text-align:center">用途</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">-s</td>
<td style="text-align:center">Num int</td>
<td style="text-align:center">指定起始页码为Num，必选项，默认为-1（不合法，强制要求重新指定）</td>
</tr>
<tr>
<td style="text-align:center">-e</td>
<td style="text-align:center">Num int</td>
<td style="text-align:center">指定结束页码为Num，必选项，默认为-1（不合法，强制要求重新指定）</td>
</tr>
<tr>
<td style="text-align:center">filename</td>
<td style="text-align:center">filename string</td>
<td style="text-align:center">指定输入文件，可选项，默认为空</td>
</tr>
<tr>
<td style="text-align:center">-l</td>
<td style="text-align:center">Num int</td>
<td style="text-align:center">指定每页的行数为Num，可选项，默认为每页72行，并且为默认解读模式</td>
</tr>
<tr>
<td style="text-align:center">-f</td>
<td style="text-align:center">无附加参数 bool</td>
<td style="text-align:center">指定解读模式为，’\f’作为页分隔符，不可与-l同时使用</td>
</tr>
<tr>
<td style="text-align:center">-d</td>
<td style="text-align:center">destination string</td>
<td style="text-align:center">指定打印机设备地址</td>
</tr>
</tbody>
</table>
<h3 id="2-5-使用实例"><a href="#2-5-使用实例" class="headerlink" title="2.5 使用实例"></a>2.5 使用实例</h3><p>以下为selpg_test.sh的内容，根据<a href="https://www.ibm.com/developerworks/cn/linux/shell/clutil/index.html" target="_blank" rel="noopener">开发Linux命令行实用程序</a>的测试要求编写，它也将作为后面的测试用例的批处理文件</p>
<pre class="line-numbers language-sh"><code class="language-sh">echo "test 1 start"
selpg -s=1 -e=1 selpg_input.txt
echo "test 1 complete"
# 1. 该命令将把“selpg_input.txt”的第 1 页写至标准输出（也就是屏幕），因为这里没有重定向或管道。

echo "test 2 start"
selpg -s=1 -e=1 < selpg_input.txt
echo "test 2 complete"
# 2. 该命令与示例 1 所做的工作相同，但在本例中，selpg 读取标准输入，而标准输入已被 shell／内核重定向为来自“selpg_input.txt”而不是显式命名的文件名参数。输入的第 1 页被写至屏幕。

echo "test 3 start"
selpg -s=2 -e=5 selpg_input.txt | selpg -s=1 -e=2
echo "test 3 complete"
# 3. “selpg -s=2 -e=5”的标准输出被 shell／内核重定向至 selpg 的标准输入。将第 1 页到第 2 页写至 selpg 的标准输出（屏幕）。

echo "test 4 start"
selpg -s=10 -e=20 selpg_input.txt > selpg_output.txt
echo "test 4 complete"
# 4. selpg 将第 10 页到第 20 页写至标准输出；标准输出被 shell／内核重定向至“selpg_output.txt”。

echo "test 5 start"
selpg -s=10 -e=20 selpg_input.txt 2> selpg_error.txt
echo "test 5 complete"
# 5. selpg 将第 10 页到第 20 页写至标准输出（屏幕）；所有的错误消息被 shell／内核重定向至“selpg_error.txt”。请注意：在“2”和“>”之间不能有空格；这是 shell 语法的一部分（请参阅“man bash”或“man sh”）。

echo "test 6 start"
selpg -s=10 -e=20 selpg_input.txt > selpg_output.txt 2> selpg_error.txt
echo "test 6 complete"
# 6. selpg 将第 10 页到第 20 页写至标准输出，标准输出被重定向至“selpg_output.txt”；selpg 写至标准错误的所有内容都被重定向至“selpg_error.txt”。当“selpg_input.txt”很大时可使用这种调用；您不会想坐在那里等着 selpg 完成工作，并且您希望对输出和错误都进行保存。

echo "test 7 start"
selpg -s=10 -e=20 selpg_input.txt > selpg_output.txt 2> /dev/null
echo "test 7 complete"
# 7. selpg 将第 10 页到第 20 页写至标准输出，标准输出被重定向至“selpg_output.txt”；selpg 写至标准错误的所有内容都被重定向至 /dev/null（空设备），这意味着错误消息被丢弃了。设备文件 /dev/null 废弃所有写至它的输出，当从该设备文件读取时，会立即返回 EOF。

echo "test 8 start"
selpg -s=10 -e=20 selpg_input.txt > /dev/null
echo "test 8 complete"
# 8. selpg 将第 10 页到第 20 页写至标准输出，标准输出被丢弃；错误消息在屏幕出现。这可作为测试 selpg 的用途，此时您也许只想（对一些测试情况）检查错误消息，而不想看到正常输出。

echo "test 9 start"
selpg -s=10 -e=20 selpg_input.txt | wc
echo "test 9 complete"
# 9. selpg 的标准输出透明地被 shell／内核重定向，成为“other_command”的标准输入，第 10 页到第 20 页被写至该标准输入。“other_command”的示例可以是 lp，它使输出在系统缺省打印机上打印。“other_command”的示例也可以 wc，它会显示选定范围的页中包含的行数、字数和字数。“other_command”可以是任何其它能从其标准输入读取的命令。错误消息仍在屏幕显示。

echo "test 10 start"
selpg -s=10 -e=20 selpg_input.txt 2> selpg_error.txt | lp
echo "test 10 complete"
# 10. 与上面的示例 9 相似，只有一点不同：错误消息被写至“selpg_error.txt”。

echo "test 11 start"
selpg -s=10 -e=20 -l=66 selpg_input.txt
echo "test 11 complete"
# 11. 该命令将页长设置为 66 行，这样 selpg 就可以把输入当作被定界为该长度的页那样处理。第 10 页到第 20 页被写至 selpg 的标准输出（屏幕）。

echo "test 12 start"
selpg -s=10 -e=20 -f selpg_input.txt 2> selpg_error.txt
echo "test 12 complete"
# 12. 假定页由换页符定界。第 10 页到第 20 页被写至 selpg 的标准输出（屏幕）。selpg 写至标准错误的所有内容都被重定向至“selpg_error.txt”。
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<h2 id="3-selpg实现逻辑"><a href="#3-selpg实现逻辑" class="headerlink" title="3. selpg实现逻辑"></a>3. selpg实现逻辑</h2><h3 id="3-1-定义参数结构体"><a href="#3-1-定义参数结构体" class="headerlink" title="3.1 定义参数结构体"></a>3.1 定义参数结构体</h3><p>为了提高程序的可读性和方便对多个参数的管理，当然也方便扩展，我们定义一个用于接受合法参数的结构体，结构体具有起始页码、结束页码、文件名、页长度、页分隔类型、打印地址等属性，其中起始页码和结束页码为必选项，其他为可选项。</p>
<pre class="line-numbers language-go"><code class="language-go"><span class="token keyword">type</span> selpgArgs <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    start    <span class="token builtin">int</span>    <span class="token comment" spellcheck="true">// index of start page</span>
    end      <span class="token builtin">int</span>    <span class="token comment" spellcheck="true">// index of end page</span>
    filename <span class="token builtin">string</span> <span class="token comment" spellcheck="true">// name of input file</span>
    length   <span class="token builtin">int</span>    <span class="token comment" spellcheck="true">// page length --- number of lines, default 72</span>
    pageType <span class="token builtin">bool</span>   <span class="token comment" spellcheck="true">// -f: true, form-feed-delimited;    -l: false, lines-delimited --- default l</span>
    des      <span class="token builtin">string</span> <span class="token comment" spellcheck="true">// device destination of printer</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="3-2-参数输入"><a href="#3-2-参数输入" class="headerlink" title="3.2 参数输入"></a>3.2 参数输入</h3><p>这里主要需要用到flag包来做参数解析。flag.XxxVar() 可以根据提供的flag，绑定该flag所对应某个参数选项中的“值”到具体的参数结构体的某个成员变量，此外还可以设置默认值和提示。与flag.XxxVar() 类似但略有不同的 flag.Xxx() 则不直接绑定参数值和变量值，而是返回一个指针，这样便提供了一个更灵活的操作。</p>
<p>根据前面所说的flag包相关知识，这里我将-s -l -f -d的值直接绑定到变量，并赋予对应的默认值和提示。这里需要解释一下-l和-f互斥条件是否满足的判断逻辑。因为-f是不带附加参数的，所以-f绑定的成员变量为bool类型，有-f则为true，为true时就说明是-f有效。乍一看好像没问题，但是仅仅这样是无法处理-l和-f同时出现的情况。然后我们想到了同时判断-l的值还是不是默认值72以及-f是否出现，这样确实可以解决绝大部分情况，但唯独一种情况无法解决，<strong>即-l 72和-f同时出现的时候</strong>。</p>
<p>因此，这里稍微做了一点改进就是，先将默认值设成非法的-1，然后调用flag.parse()后判断length是否有被设置过（非-1即为设置过），如果有被设置则认为用户需要-l模式，而此时如果又有-f，就判断为冲突。反之，如果length还是-1，则认为用户没有启用-l模式（即使用户手动将length设成了-1，但这是非法的），这种情况下如果有-f就不会冲突，如果没有-f，则认为用户还是需要-l模式，这时再将length长度设置回默认值72。</p>
<p>最后是调用flag.Args()获取未处理的参数，即没有flag标识的参数如文件名，在本例中只允许至多有一个文件名，故剩余未处理参数大于1时就是命令错误。</p>
<pre class="line-numbers language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">inputArgs</span><span class="token punctuation">(</span>args <span class="token operator">*</span>selpgArgs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    flag<span class="token punctuation">.</span><span class="token function">IntVar</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>start<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"s"</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"start page"</span><span class="token punctuation">)</span>
    flag<span class="token punctuation">.</span><span class="token function">IntVar</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>end<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"e"</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"end page"</span><span class="token punctuation">)</span>
    flag<span class="token punctuation">.</span><span class="token function">IntVar</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"l"</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"page length"</span><span class="token punctuation">)</span>
    flag<span class="token punctuation">.</span><span class="token function">BoolVar</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>pageType<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"f"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">"page type"</span><span class="token punctuation">)</span>
    flag<span class="token punctuation">.</span><span class="token function">StringVar</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>des<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"d"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"print destination"</span><span class="token punctuation">)</span>s

    flag<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// deal with -l and -f, especially -l 72 and -f</span>
    <span class="token keyword">if</span> args<span class="token punctuation">.</span>length <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> args<span class="token punctuation">.</span>pageType <span class="token operator">==</span> <span class="token boolean">true</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stderr<span class="token punctuation">,</span> <span class="token string">"-l Num and -f cannot be used together\n"</span><span class="token punctuation">)</span>
        os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> args<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">{</span>
        args<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">72</span>
    <span class="token punctuation">}</span>

    others <span class="token operator">:=</span> flag<span class="token punctuation">.</span><span class="token function">Args</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>others<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">{</span>
        args<span class="token punctuation">.</span>filename <span class="token operator">=</span> others<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>others<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        args<span class="token punctuation">.</span>filename <span class="token operator">=</span> <span class="token string">""</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stderr<span class="token punctuation">,</span> <span class="token string">"too many arguments\n"</span><span class="token punctuation">)</span>
        os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="3-3-参数检查"><a href="#3-3-参数检查" class="headerlink" title="3.3 参数检查"></a>3.3 参数检查</h3><p>这里检查了四种可以在运行前判断的错误情况：</p>
<ul>
<li>起止页码过小，必须从1开始</li>
<li>起止页码过大，不能溢出</li>
<li>起始页码大于结束页码</li>
<li>页长度过小或溢出<pre class="line-numbers language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">checkArgs</span><span class="token punctuation">(</span>args <span class="token operator">*</span>selpgArgs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> args<span class="token punctuation">.</span>start <span class="token operator">&lt;</span> <span class="token number">1</span> <span class="token operator">||</span> args<span class="token punctuation">.</span>end <span class="token operator">&lt;</span> <span class="token number">1</span> <span class="token punctuation">{</span>
      fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stderr<span class="token punctuation">,</span> <span class="token string">"the number of start page and end page should start from 1\n"</span><span class="token punctuation">)</span>
      os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> args<span class="token punctuation">.</span>start <span class="token operator">></span> math<span class="token punctuation">.</span>MaxInt32<span class="token number">-1</span> <span class="token operator">||</span> args<span class="token punctuation">.</span>end <span class="token operator">></span> math<span class="token punctuation">.</span>MaxInt32<span class="token number">-1</span> <span class="token punctuation">{</span>
      fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stderr<span class="token punctuation">,</span> <span class="token string">"the number of start page and end page should not larger than MAX INT\n"</span><span class="token punctuation">)</span>
      os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> args<span class="token punctuation">.</span>start <span class="token operator">></span> args<span class="token punctuation">.</span>end <span class="token punctuation">{</span>
      fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stderr<span class="token punctuation">,</span> <span class="token string">"the number of start page should not larger than the number of end page\n"</span><span class="token punctuation">)</span>
      os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> args<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">1</span> <span class="token operator">||</span> args<span class="token punctuation">.</span>length <span class="token operator">></span> math<span class="token punctuation">.</span>MaxInt32<span class="token number">-1</span> <span class="token punctuation">{</span>
      fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stderr<span class="token punctuation">,</span> <span class="token string">"invalid page length\n"</span><span class="token punctuation">)</span>
      os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<h3 id="3-4-数据输入和处理"><a href="#3-4-数据输入和处理" class="headerlink" title="3.4 数据输入和处理"></a>3.4 数据输入和处理</h3><p>思路是先根据不同输入方式（标准输入或文件输入）获取reader，用于处理后面的读操作。然后再根据不同输出方式（标准输出或打印机）获取writer，用于处理后面的写操作。两个对象都获得的之后，再根据页分隔类型解析输入，将reader和writer传入对应的处理函数。<br>最后还需要留意地方是文件指针需要延迟关闭，以及一个错误判断——起止页码都不能大于输入所拥有的最大页码，这个最大页码是作为选项参数的处理函数返回获得的。</p>
<pre class="line-numbers language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">processData</span><span class="token punctuation">(</span>args <span class="token operator">*</span>selpgArgs<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">var</span> reader <span class="token operator">*</span>bufio<span class="token punctuation">.</span>Reader
    <span class="token keyword">if</span> args<span class="token punctuation">.</span>filename <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>
        reader <span class="token operator">=</span> bufio<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stdin<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        filein<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>filename<span class="token punctuation">)</span>
        <span class="token keyword">defer</span> filein<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stderr<span class="token punctuation">,</span> <span class="token string">"failed to open file %s\n"</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span>filename<span class="token punctuation">)</span>
            os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        reader <span class="token operator">=</span> bufio<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>filein<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    pageCount <span class="token operator">:=</span> <span class="token number">1</span>

    <span class="token keyword">if</span> args<span class="token punctuation">.</span>des <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>
        writer <span class="token operator">:=</span> bufio<span class="token punctuation">.</span><span class="token function">NewWriter</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stdout<span class="token punctuation">)</span>
        <span class="token keyword">if</span> args<span class="token punctuation">.</span>pageType <span class="token punctuation">{</span>
            pageCount <span class="token operator">=</span> <span class="token function">optionF</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> reader<span class="token punctuation">,</span> writer<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            pageCount <span class="token operator">=</span> <span class="token function">optionL</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> reader<span class="token punctuation">,</span> writer<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        cmd <span class="token operator">:=</span> exec<span class="token punctuation">.</span><span class="token function">Command</span><span class="token punctuation">(</span><span class="token string">"lp"</span><span class="token punctuation">,</span> <span class="token string">"-d"</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span>des<span class="token punctuation">)</span>
        writer<span class="token punctuation">,</span> err <span class="token operator">:=</span> cmd<span class="token punctuation">.</span><span class="token function">StdinPipe</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">defer</span> writer<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stderr<span class="token punctuation">,</span> <span class="token string">"stdin pipe error\n"</span><span class="token punctuation">)</span>
            os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        err <span class="token operator">=</span> cmd<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stderr<span class="token punctuation">,</span> <span class="token string">"command start error\n"</span><span class="token punctuation">)</span>
            os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> args<span class="token punctuation">.</span>pageType <span class="token punctuation">{</span>
            pageCount <span class="token operator">=</span> <span class="token function">optionFD</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> reader<span class="token punctuation">,</span> writer<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            pageCount <span class="token operator">=</span> <span class="token function">optionLD</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> reader<span class="token punctuation">,</span> writer<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        err <span class="token operator">=</span> cmd<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stderr<span class="token punctuation">,</span> <span class="token string">"command wait error\n"</span><span class="token punctuation">)</span>
            os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> pageCount <span class="token operator">&lt;</span> args<span class="token punctuation">.</span>start <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stderr<span class="token punctuation">,</span> <span class="token string">"the number of start page does not exist\n"</span><span class="token punctuation">)</span>
        os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> pageCount <span class="token operator">&lt;</span> args<span class="token punctuation">.</span>end <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stderr<span class="token punctuation">,</span> <span class="token string">"the number of end page does not exist\n"</span><span class="token punctuation">)</span>
        os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="3-5-选项操作"><a href="#3-5-选项操作" class="headerlink" title="3.5 选项操作"></a>3.5 选项操作</h3><p>两者实现思路差不多，都是到达页分隔阈值的时候页计数器增加1（如果有行计数器则需要重置），边读变写，只不过固定行数的页分隔模式多了一个行数的计数器lineCount，以及’\f’的解析模式只能逐个字节读写。</p>
<ul>
<li>固定行数页分隔模式</li>
</ul>
<pre class="line-numbers language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">optionL</span><span class="token punctuation">(</span>args <span class="token operator">*</span>selpgArgs<span class="token punctuation">,</span> reader <span class="token operator">*</span>bufio<span class="token punctuation">.</span>Reader<span class="token punctuation">,</span> writer <span class="token operator">*</span>bufio<span class="token punctuation">.</span>Writer<span class="token punctuation">)</span> <span class="token punctuation">(</span>pageCount <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    pageCount <span class="token operator">=</span> <span class="token number">1</span>
    lineCount <span class="token operator">:=</span> <span class="token number">1</span>
    <span class="token keyword">for</span> <span class="token punctuation">{</span>
        line<span class="token punctuation">,</span> err <span class="token operator">:=</span> reader<span class="token punctuation">.</span><span class="token function">ReadBytes</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> err <span class="token operator">==</span> io<span class="token punctuation">.</span>EOF <span class="token punctuation">{</span>
                <span class="token keyword">break</span>
            <span class="token punctuation">}</span>
            fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stderr<span class="token punctuation">,</span> <span class="token string">"failed to read bytes, %s\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> pageCount <span class="token operator">>=</span> args<span class="token punctuation">.</span>start <span class="token operator">&amp;&amp;</span> pageCount <span class="token operator">&lt;=</span> args<span class="token punctuation">.</span>end <span class="token punctuation">{</span>
            <span class="token boolean">_</span><span class="token punctuation">,</span> writeErr <span class="token operator">:=</span> writer<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span>
            <span class="token keyword">if</span> writeErr <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stderr<span class="token punctuation">,</span> <span class="token string">"failed to write bytes\n"</span><span class="token punctuation">)</span>
                os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            writer<span class="token punctuation">.</span><span class="token function">Flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> lineCount <span class="token operator">>=</span> args<span class="token punctuation">.</span>length <span class="token punctuation">{</span>
            pageCount<span class="token operator">++</span>
            lineCount <span class="token operator">=</span> <span class="token number">1</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            lineCount<span class="token operator">++</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> pageCount
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">optionFD</span><span class="token punctuation">(</span>args <span class="token operator">*</span>selpgArgs<span class="token punctuation">,</span> reader <span class="token operator">*</span>bufio<span class="token punctuation">.</span>Reader<span class="token punctuation">,</span> writer io<span class="token punctuation">.</span>WriteCloser<span class="token punctuation">)</span> <span class="token punctuation">(</span>pageCount <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    pageCount <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token keyword">for</span> <span class="token punctuation">{</span>
        ch<span class="token punctuation">,</span> err <span class="token operator">:=</span> reader<span class="token punctuation">.</span><span class="token function">ReadByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> err <span class="token operator">==</span> io<span class="token punctuation">.</span>EOF <span class="token punctuation">{</span>
                <span class="token keyword">break</span>
            <span class="token punctuation">}</span>
            fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stderr<span class="token punctuation">,</span> <span class="token string">"failed to read byte\n"</span><span class="token punctuation">)</span>
            os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">17</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> pageCount <span class="token operator">>=</span> args<span class="token punctuation">.</span>start <span class="token operator">&amp;&amp;</span> pageCount <span class="token operator">&lt;=</span> args<span class="token punctuation">.</span>end <span class="token punctuation">{</span>
            <span class="token boolean">_</span><span class="token punctuation">,</span> writeErr <span class="token operator">:=</span> writer<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">{</span>ch<span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> writeErr <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stderr<span class="token punctuation">,</span> <span class="token string">"failed to write bytes\n"</span><span class="token punctuation">)</span>
                os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> ch <span class="token operator">==</span> <span class="token string">'\f'</span> <span class="token punctuation">{</span>
            pageCount<span class="token operator">++</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> pageCount
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>‘\f’页分隔模式</li>
</ul>
<pre class="line-numbers language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">optionF</span><span class="token punctuation">(</span>args <span class="token operator">*</span>selpgArgs<span class="token punctuation">,</span> reader <span class="token operator">*</span>bufio<span class="token punctuation">.</span>Reader<span class="token punctuation">,</span> writer <span class="token operator">*</span>bufio<span class="token punctuation">.</span>Writer<span class="token punctuation">)</span> <span class="token punctuation">(</span>pageCount <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    pageCount <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token keyword">for</span> <span class="token punctuation">{</span>
        ch<span class="token punctuation">,</span> err <span class="token operator">:=</span> reader<span class="token punctuation">.</span><span class="token function">ReadByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> err <span class="token operator">==</span> io<span class="token punctuation">.</span>EOF <span class="token punctuation">{</span>
                <span class="token keyword">break</span>
            <span class="token punctuation">}</span>
            fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stderr<span class="token punctuation">,</span> <span class="token string">"failed to read byte\n"</span><span class="token punctuation">)</span>
            os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> pageCount <span class="token operator">>=</span> args<span class="token punctuation">.</span>start <span class="token operator">&amp;&amp;</span> pageCount <span class="token operator">&lt;=</span> args<span class="token punctuation">.</span>end <span class="token punctuation">{</span>
            writeErr <span class="token operator">:=</span> writer<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span>
            <span class="token keyword">if</span> writeErr <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stderr<span class="token punctuation">,</span> <span class="token string">"failed to write byte\n"</span><span class="token punctuation">)</span>
                os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            writer<span class="token punctuation">.</span><span class="token function">Flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> ch <span class="token operator">==</span> <span class="token string">'\f'</span> <span class="token punctuation">{</span>
            pageCount<span class="token operator">++</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> pageCount
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="3-6-错误处理总览"><a href="#3-6-错误处理总览" class="headerlink" title="3.6 错误处理总览"></a>3.6 错误处理总览</h3><table>
<thead>
<tr>
<th style="text-align:center">错误码</th>
<th style="text-align:center">原因</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">-l和-f冲突</td>
</tr>
<tr>
<td style="text-align:center">2</td>
<td style="text-align:center">参数过多</td>
</tr>
<tr>
<td style="text-align:center">3</td>
<td style="text-align:center">起止页码过小</td>
</tr>
<tr>
<td style="text-align:center">4</td>
<td style="text-align:center">起止页码溢出</td>
</tr>
<tr>
<td style="text-align:center">5</td>
<td style="text-align:center">起始页码大于结束页码</td>
</tr>
<tr>
<td style="text-align:center">6</td>
<td style="text-align:center">页长度过小或溢出</td>
</tr>
<tr>
<td style="text-align:center">7</td>
<td style="text-align:center">文件打开错误</td>
</tr>
<tr>
<td style="text-align:center">8</td>
<td style="text-align:center">管道创建错误</td>
</tr>
<tr>
<td style="text-align:center">9</td>
<td style="text-align:center">子进程启动错误</td>
</tr>
<tr>
<td style="text-align:center">10</td>
<td style="text-align:center">子进程等待错误</td>
</tr>
<tr>
<td style="text-align:center">11</td>
<td style="text-align:center">起始页码大于最大页码</td>
</tr>
<tr>
<td style="text-align:center">12</td>
<td style="text-align:center">结束页码大于最大页码</td>
</tr>
<tr>
<td style="text-align:center">13</td>
<td style="text-align:center">字节读错误</td>
</tr>
<tr>
<td style="text-align:center">14</td>
<td style="text-align:center">字节写错误</td>
</tr>
<tr>
<td style="text-align:center">15</td>
<td style="text-align:center">字节流读错误</td>
</tr>
<tr>
<td style="text-align:center">16</td>
<td style="text-align:center">字节流写错误</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="4-测试"><a href="#4-测试" class="headerlink" title="4. 测试"></a>4. 测试</h2><p>这里使用前面提到的测试用例，先对selpg进行go install以便全局使用，再将终端定位到批处理文件所在目录，键入<code>sh selpg_test.sh</code>以运行测试</p>
<h3 id="4-1-test1-selpg-s-1-e-1-selpg-input-txt"><a href="#4-1-test1-selpg-s-1-e-1-selpg-input-txt" class="headerlink" title="4.1 test1: selpg -s=1 -e=1 selpg_input.txt"></a>4.1 test1: selpg -s=1 -e=1 selpg_input.txt</h3><ul>
<li><strong>含义</strong>：该命令将把“selpg_input.txt”的第 1 页写至标准输出（也就是屏幕），因为这里没有重定向或管道。</li>
<li><strong>结果分析</strong>：输出了1~72，符合预期结果<br><img src="/2018/10/11/SC-hw2-selpg/test1_s.png" alt=""><br><img src="/2018/10/11/SC-hw2-selpg/test1_c.png" alt=""></li>
</ul>
<h3 id="4-2-test2-selpg-s-1-e-1-lt-selpg-input-txt"><a href="#4-2-test2-selpg-s-1-e-1-lt-selpg-input-txt" class="headerlink" title="4.2 test2: selpg -s=1 -e=1 &lt; selpg_input.txt"></a>4.2 test2: selpg -s=1 -e=1 &lt; selpg_input.txt</h3><ul>
<li><strong>含义</strong>：该命令与示例 1 所做的工作相同，但在本例中，selpg 读取标准输入，而标准输入已被 shell／内核重定向为来自“selpg_input.txt”而不是显式命名的文件名参数。输入的第 1 页被写至屏幕。</li>
<li><strong>结果分析</strong>：同样的，输出了1~72，符合预期结果<br><img src="/2018/10/11/SC-hw2-selpg/test2_s.png" alt=""><br><img src="/2018/10/11/SC-hw2-selpg/test2_c.png" alt=""></li>
</ul>
<h3 id="4-3-test3-selpg-s-2-e-5-selpg-input-txt-selpg-s-1-e-2"><a href="#4-3-test3-selpg-s-2-e-5-selpg-input-txt-selpg-s-1-e-2" class="headerlink" title="4.3 test3: selpg -s=2 -e=5 selpg_input.txt | selpg -s=1 -e=2"></a>4.3 test3: selpg -s=2 -e=5 selpg_input.txt | selpg -s=1 -e=2</h3><ul>
<li><strong>含义</strong>：“selpg -s=2 -e=5”的标准输出被 shell／内核重定向至 selpg 的标准输入。将第 1 页到第 2 页写至 selpg 的标准输出（屏幕）。</li>
<li><strong>结果分析</strong>：这里将第一个selpg的标准输出，即selpg_input.txt的第 2 页到第 5 页作为下个selpg程序的标准输入，并输出该输入下的第 1 页到第 2 页，因此屏幕输出应为原selpg_input.txt的第 2 页到第 3 页，即73~216，符合预期结果。<br><img src="/2018/10/11/SC-hw2-selpg/test3_s.png" alt=""><br><img src="/2018/10/11/SC-hw2-selpg/test3_c.png" alt=""></li>
</ul>
<h3 id="4-4-test4-test8"><a href="#4-4-test4-test8" class="headerlink" title="4.4 test4~test8"></a>4.4 test4~test8</h3><ul>
<li><strong>selpg -s=10 -e=20 selpg_input.txt &gt; selpg_output.txt</strong><br>selpg 将第 10 页到第 20 页写至标准输出；标准输出被 shell／内核重定向至“selpg_output.txt”。</li>
<li><strong>selpg -s=10 -e=20 selpg_input.txt 2&gt; selpg_error.txt</strong><br>selpg 将第 10 页到第 20 页写至标准输出（屏幕）；所有的错误消息被 shell／内核重定向至“selpg_error.txt”。请注意：在“2”和“&gt;”之间不能有空格；这是 shell 语法的一部分（请参阅“man bash”或“man sh”）。</li>
<li><strong>selpg -s=10 -e=20 selpg_input.txt &gt; selpg_output.txt 2&gt; selpg_error.txt</strong><br>selpg 将第 10 页到第 20 页写至标准输出，标准输出被重定向至“selpg_output.txt”；selpg 写至标准错误的所有内容都被重定向至“selpg_error.txt”。当“selpg_input.txt”很大时可使用这种调用；您不会想坐在那里等着 selpg 完成工作，并且您希望对输出和错误都进行保存。</li>
<li><strong>selpg -s=10 -e=20 selpg_input.txt &gt; selpg_output.txt 2&gt; /dev/null</strong><br>selpg 将第 10 页到第 20 页写至标准输出，标准输出被重定向至“selpg_output.txt”；selpg 写至标准错误的所有内容都被重定向至 /dev/null（空设备），这意味着错误消息被丢弃了。设备文件 /dev/null 废弃所有写至它的输出，当从该设备文件读取时，会立即返回 EOF。</li>
<li><strong>selpg -s=10 -e=20 selpg_input.txt &gt; /dev/null</strong><br>selpg 将第 10 页到第 20 页写至标准输出，标准输出被丢弃；错误消息在屏幕出现。这可作为测试 selpg 的用途，此时您也许只想（对一些测试情况）检查错误消息，而不想看到正常输出。</li>
<li><strong>结果分析</strong>：<ul>
<li><strong>test4</strong>：在文件中输出649~1440，符合<br><img src="/2018/10/11/SC-hw2-selpg/output_s.png" alt=""><br><img src="/2018/10/11/SC-hw2-selpg/output_c.png" alt=""></li>
<li><strong>test5</strong>：输出649~1440，符合<br><img src="/2018/10/11/SC-hw2-selpg/test45_s.png" alt=""><br><img src="/2018/10/11/SC-hw2-selpg/test5678_c.png" alt=""></li>
<li><strong>test6</strong>：可以看到 test 6 start 后就complete了，结果输出在文件中——同test4，错误输出被废弃，符合。</li>
<li><strong>test7</strong>：可以看到 test 7 start 后就complete了，结果输出在文件中——同test4，错误输出被废弃，符合。</li>
<li><strong>test8</strong>：可以看到 test 8 start 后就complete了，结果输出被废弃，符合。</li>
</ul>
</li>
</ul>
<h3 id="4-5-test9-test10"><a href="#4-5-test9-test10" class="headerlink" title="4.5 test9~test10"></a>4.5 test9~test10</h3><p><code>command | other_command</code><br>selpg 的标准输出透明地被 shell／内核重定向，成为“other_command”的标准输入，第 10 页到第 20 页被写至该标准输入。“other_command”可以是任何其它能从其标准输入读取的命令。错误消息仍在屏幕显示。</p>
<ul>
<li><strong>selpg -s=10 -e=20 selpg_input.txt | wc</strong><br>“other_command”的示例也可以 wc，它会显示选定范围的页中包含的行数、字数和字数。</li>
<li><strong>selpg -s=10 -e=20 selpg_input.txt 2&gt; selpg_error.txt | lp</strong><br>“other_command”的示例可以是 lp，它使输出在系统缺省打印机上打印。与上面的 test 9 相似，只有一点不同：错误消息被写至“selpg_error.txt”。</li>
<li><strong>结果分析</strong>：<ul>
<li><strong>test9</strong>：可以看到行数、单词数、字节数分别为793（11*72） 793（11*72） 3647</li>
<li><strong>test10</strong>：因为没有连接到打印机，所以直接lp会报错<br><img src="/2018/10/11/SC-hw2-selpg/test9_10.png" alt=""></li>
</ul>
</li>
</ul>
<h3 id="4-6-test11-selpg-s-10-e-20-l-66-selpg-input-txt"><a href="#4-6-test11-selpg-s-10-e-20-l-66-selpg-input-txt" class="headerlink" title="4.6 test11: selpg -s=10 -e=20 -l=66 selpg_input.txt"></a>4.6 test11: selpg -s=10 -e=20 -l=66 selpg_input.txt</h3><ul>
<li><strong>含义</strong>：该命令将页长设置为 66 行，这样 selpg 就可以把输入当作被定界为该长度的页那样处理。第 10 页到第 20 页被写至 selpg 的标准输出（屏幕）。</li>
<li><strong>结果分析</strong>：每页66行的话，第 10 页到第 11 页就是 595 ~ 1320，符合<br><img src="/2018/10/11/SC-hw2-selpg/test11_s.png" alt=""><br><img src="/2018/10/11/SC-hw2-selpg/test11_c.png" alt=""></li>
</ul>
<h3 id="4-7-test12-selpg-s-10-e-20-f-selpg-input-txt-2-gt-selpg-error-txt"><a href="#4-7-test12-selpg-s-10-e-20-f-selpg-input-txt-2-gt-selpg-error-txt" class="headerlink" title="4.7 test12: selpg -s=10 -e=20 -f selpg_input.txt 2&gt; selpg_error.txt"></a>4.7 test12: selpg -s=10 -e=20 -f selpg_input.txt 2&gt; selpg_error.txt</h3><ul>
<li><strong>含义</strong>：假定页由换页符定界。第 10 页到第 20 页被写至 selpg 的标准输出（屏幕）。selpg 写至标准错误的所有内容都被重定向至“selpg_error.txt”。</li>
<li><strong>结果分析</strong>：因为输入文件没有设置分页符，所以相当于只有 1 页，因此会发生起止页码大于最大页码的错误，并输出到文件中，符合<br><img src="/2018/10/11/SC-hw2-selpg/test12.png" alt=""><br><img src="/2018/10/11/SC-hw2-selpg/error.png" alt=""></li>
</ul>

            </div>

            <!-- Post Comments -->
            
    <!-- 使用 DISQUS_CLICK -->
<div id="disqus-comment">
    <div id="disqus_thread"></div>

<!-- add animation -->
<style>
	.disqus_click_btn {
            line-height: 30px;
            margin: 0;
            min-width: 50px;
            padding: 0 14px;
            display: inline-block;
            font-family: "Roboto", "Helvetica", "Arial", sans-serif;
            font-size: 14px;
            font-weight: 400;
            text-transform: uppercase;
            letter-spacing: 0;
            overflow: hidden;
            will-change: box-shadow;
            transition: box-shadow .2s cubic-bezier(.4, 0, 1, 1), background-color .2s cubic-bezier(.4, 0, .2, 1), color .2s cubic-bezier(.4, 0, .2, 1);
            outline: 0;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
            vertical-align: middle;
            border: 0;
            background: rgba(158, 158, 158, .2);
            box-shadow: 0 2px 2px 0 rgba(0, 0, 0, .14), 0 3px 1px -2px rgba(0, 0, 0, .2), 0 1px 5px 0 rgba(0, 0, 0, .12);
            color: #fff;
            background-color: #7EC0EE;
            text-shadow: 0
        }
</style>
	
<div class="btn_click_load" id="disqus_bt"> 
    <button class="disqus_click_btn">点击查看评论</button>
</div>

<!--
<script type="text/javascript">
$('.btn_click_load').click(function() {
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'http-miccall-tech'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    document.getElementById('disqus_bt').style.display = "none";
});
</script>
-->
<script type="text/javascript">
    var disqus_config = function () {
        this.page.url = 'http://yoursite.com/2018/10/11/SC-hw2-selpg/';  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = 'http://yoursite.com/2018/10/11/SC-hw2-selpg/'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
</script>

<script type="text/javascript">
    $('.btn_click_load').click(function() {  //click to load comments
        (function() { // DON'T EDIT BELOW THIS LINE
            var d = document;
            var s = d.createElement('script');
            s.src = '//http-miccall-tech.disqus.com/embed.js';
            s.setAttribute('data-timestamp', + new Date());
            (d.head || d.body).appendChild(s);
        })();
        $('.btn_click_load').css('display','none');
    });
</script>
</div>
<style>
    #disqus-comment{
        background-color: #eee;
        padding: 2pc;
    }
</style>


        </div>
        <!-- Copyright 版权 start -->
                <div id="copyright">
            <ul>
                <li>&copy;Powered By <a href="https://hexo.io/zh-cn/" style="border-bottom: none;">hexo</a></li>
                <li>Written By: <a href="https://github.com/gitgiter" style="border-bottom: none;">gitgiter</a></li>
            </ul>
            
            	<span id="busuanzi_container_site_pv">2019总访问量<span id="busuanzi_value_site_pv"></span>次</span>
			
        </div>
    </div>
</body>



 	
</html>
